apiVersion: batch/v1
kind: CronJob
metadata:
  name: laravel-scheduler
  labels:
    app: laravel
    component: scheduler
spec:
  schedule: "* * * * *"  # Run every minute
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          imagePullSecrets:
            - name: ecr-secret
          initContainers:
            - name: wait-for-mysql
              image: busybox
              command: ['sh', '-c', 'until nc -z mysql 3306; do echo "Waiting for MySQL..."; sleep 5; done']
            - name: fix-storage-permissions
              image: busybox
              command: ["sh", "-c", "chown -R www-data:www-data /var/www/storage"]
              volumeMounts:
                - name: laravel-storage
                  mountPath: /var/www/storage
          volumes:
            - name: laravel-storage
              persistentVolumeClaim:
                claimName: laravel-storage-pvc
          containers:
            - name: scheduler
              image: 043309367638.dkr.ecr.us-east-1.amazonaws.com/laravel-k8s:latest
              command: ["php", "artisan", "schedule:run"]
              env:
                - name: DB_HOST
                  value: mysql
              envFrom:
                - secretRef:
                    name: laravel-secrets
              volumeMounts:
                - name: laravel-storage
                  mountPath: /var/www/storage
              resources:
                requests:
                  cpu: "100m"
                  memory: "128Mi"
                limits:
                  cpu: "200m"
                  memory: "256Mi" 